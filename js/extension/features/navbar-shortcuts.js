 /**
 *
 * Discogs Enhancer
 *
 * @author: Matthew Salcido
 * @website: http://www.msalcido.com
 * @github: https://github.com/salcido
 *
 * This feature allows users to add shortcuts
 * to various pages by appending icons to the
 * main navbar.
 */
 rl.ready(() => {

  let newHeader = document.querySelector('div[id*="__header"]');

  if (!newHeader) return;

  const host = document.querySelector('[id^=__header_root_]');
  const username = rl.username();

  const COLLECTION_URL = `/user/${username}/collection`;
  const ITEMSIWANT_URL = '/sell/mywants';
  const SUBMISSIONS_DRAFTS_URL = '/users/drafts';
  const PURCHASES_URL = '/sell/purchases';
  const INVENTORY_URL = '/sell/manage';
  const ORDERS_URL = '/sell/orders';

  const COLLECTION_ICON = '<svg class="_icon_1yizy_1" viewBox="0 0 24 24" role="img" aria-hidden="true"><path d="M20.51 21.52c-.82 0-1.48-.66-1.48-1.48V4.48a1.49 1.49 0 0 1 2.97 0v15.54c0 .82-.67 1.5-1.49 1.5Zm-3.92 0a1.5 1.5 0 0 1-1.5-1.48V4.48a1.49 1.49 0 0 1 2.98 0v15.54c0 .82-.66 1.5-1.48 1.5Zm-3.93 0c-.82 0-1.49-.66-1.49-1.48V4.48a1.49 1.49 0 0 1 2.98 0v15.54c0 .82-.67 1.5-1.5 1.5Zm-9.18-.45a1.49 1.49 0 0 1-1.4-2L7.34 4.45a1.49 1.49 0 1 1 2.8 1L4.88 20.08c-.22.6-.79.99-1.4.99Z"></path></svg>';

  const ITEMSIWANT_ICON = '<svg class="_icon_1yizy_1" role="img" width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.0153 10.28L7.21652 20.7787C7.11268 20.8895 6.97561 20.9635 6.826 20.9896C6.67639 21.0157 6.52236 20.9924 6.38715 20.9233C6.25193 20.8541 6.14287 20.7429 6.07642 20.6063C6.00998 20.4698 5.98975 20.3153 6.01879 20.1662L7.30138 13.7507L2.25939 11.8574C2.1511 11.8169 2.05454 11.7502 1.97832 11.6633C1.9021 11.5763 1.84861 11.4719 1.82261 11.3592C1.79662 11.2466 1.79893 11.1292 1.82935 11.0177C1.85976 10.9062 1.91733 10.8039 1.99692 10.72L11.7957 0.221341C11.8995 0.110523 12.0366 0.0364864 12.1862 0.0104022C12.3358 -0.0156821 12.4899 0.00760181 12.6251 0.0767403C12.7603 0.145879 12.8693 0.25712 12.9358 0.393679C13.0022 0.530237 13.0225 0.684702 12.9934 0.833765L11.7073 7.25634L16.7493 9.14698C16.8568 9.18776 16.9526 9.25438 17.0282 9.34097C17.1039 9.42755 17.157 9.53143 17.1829 9.64343C17.2089 9.75542 17.2068 9.87208 17.177 9.9831C17.1471 10.0941 17.0904 10.1961 17.0118 10.28H17.0153Z" fill="#FEFEFE"></path></svg>';

  const SUBMISSIONS_DRAFTS_ICON = '<svg class="_icon_1yizy_1" role="img" width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg"><path d="M17.1285 2.75C17.1285 2.91576 17.0627 3.07473 16.9455 3.19194C16.8283 3.30915 16.6693 3.375 16.5035 3.375H15.2535V4.625C15.2535 4.79076 15.1877 4.94973 15.0705 5.06694C14.9533 5.18415 14.7943 5.25 14.6285 5.25C14.4628 5.25 14.3038 5.18415 14.1866 5.06694C14.0694 4.94973 14.0035 4.79076 14.0035 4.625V3.375H12.7535C12.5878 3.375 12.4288 3.30915 12.3116 3.19194C12.1944 3.07473 12.1285 2.91576 12.1285 2.75C12.1285 2.58424 12.1944 2.42527 12.3116 2.30806C12.4288 2.19085 12.5878 2.125 12.7535 2.125H14.0035V0.875C14.0035 0.70924 14.0694 0.550268 14.1866 0.433058C14.3038 0.315848 14.4628 0.25 14.6285 0.25C14.7943 0.25 14.9533 0.315848 15.0705 0.433058C15.1877 0.550268 15.2535 0.70924 15.2535 0.875V2.125H16.5035C16.6693 2.125 16.8283 2.19085 16.9455 2.30806C17.0627 2.42527 17.1285 2.58424 17.1285 2.75ZM11.5504 5.08281L11.0223 4.55469C10.5617 4.10434 10.2872 3.49722 10.2535 2.85391C10.24 2.54479 10.2843 2.23587 10.384 1.94297C10.4016 1.88991 10.4046 1.8331 10.3927 1.77847C10.3809 1.72385 10.3546 1.6734 10.3166 1.63238C10.2787 1.59137 10.2304 1.5613 10.1768 1.5453C10.1232 1.52929 10.0664 1.52795 10.0121 1.54141L5.10197 2.76953C4.96689 2.8033 4.84695 2.8812 4.76118 2.99089C4.67541 3.10058 4.62873 3.23576 4.62853 3.375V11.9766C4.26231 11.7311 3.84351 11.5751 3.40592 11.5213C2.96833 11.4674 2.52421 11.5172 2.10941 11.6666C1.69461 11.8161 1.32074 12.0609 1.01798 12.3814C0.715224 12.7019 0.492054 13.0891 0.366484 13.5117C0.240914 13.9343 0.216461 14.3806 0.295099 14.8144C0.373738 15.2482 0.553264 15.6575 0.819189 16.0091C1.08512 16.3608 1.42999 16.645 1.82598 16.8388C2.22198 17.0327 2.65799 17.1307 3.09884 17.125C4.64806 17.107 5.87853 15.807 5.87853 14.2578V6.98828L11.4051 5.60625C11.4586 5.59278 11.5076 5.56538 11.5471 5.52684C11.5866 5.48829 11.6152 5.43997 11.63 5.38679C11.6447 5.33361 11.6451 5.27747 11.6312 5.22407C11.6172 5.17068 11.5893 5.12194 11.5504 5.08281ZM15.4653 6.98203C15.2848 7.04575 15.0976 7.08848 14.9074 7.10938C14.8305 7.11769 14.7594 7.15425 14.7079 7.21198C14.6564 7.26971 14.6281 7.3445 14.6285 7.42188V9.47656C14.2623 9.23107 13.8435 9.07511 13.4059 9.02128C12.9683 8.96745 12.5242 9.01724 12.1094 9.16665C11.6946 9.31605 11.3207 9.56089 11.018 9.88139C10.7152 10.2019 10.4921 10.5891 10.3665 11.0117C10.2409 11.4343 10.2165 11.8806 10.2951 12.3144C10.3737 12.7482 10.5533 13.1575 10.8192 13.5091C11.0851 13.8608 11.43 14.145 11.826 14.3388C12.222 14.5327 12.658 14.6307 13.0988 14.625C14.6481 14.607 15.8785 13.3078 15.8785 11.7578V7.28125C15.8791 7.23127 15.8676 7.18189 15.8451 7.13725C15.8227 7.09261 15.7898 7.05402 15.7493 7.0247C15.7088 6.99539 15.6619 6.97622 15.6125 6.9688C15.563 6.96137 15.5126 6.96591 15.4653 6.98203Z"></path></svg>';

  const PURCHASES_ICON = '<svg class="_icon_1yizy_1" role="img" width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M18.0769 3.66113H2.42308C2.04565 3.66113 1.68369 3.81917 1.41681 4.10047C1.14993 4.38178 1 4.76331 1 5.16113V19.4111C1.00006 19.539 1.03112 19.6647 1.09023 19.7763C1.14934 19.8879 1.23453 19.9817 1.33772 20.0489C1.44091 20.116 1.55867 20.1543 1.67982 20.16C1.80097 20.1657 1.9215 20.1386 2.02995 20.0814L4.55769 18.7493L7.08543 20.0814C7.18429 20.1336 7.29331 20.1607 7.40385 20.1607C7.51439 20.1607 7.62341 20.1336 7.72226 20.0814L10.25 18.7493L12.7777 20.0814C12.8766 20.1336 12.9856 20.1607 13.0962 20.1607C13.2067 20.1607 13.3157 20.1336 13.4146 20.0814L15.9423 18.7493L18.4701 20.0814C18.5785 20.1386 18.699 20.1657 18.8202 20.16C18.9413 20.1543 19.0591 20.116 19.1623 20.0489C19.2655 19.9817 19.3507 19.8879 19.4098 19.7763C19.4689 19.6647 19.4999 19.539 19.5 19.4111V5.16113C19.5 4.76331 19.3501 4.38178 19.0832 4.10047C18.8163 3.81917 18.4543 3.66113 18.0769 3.66113ZM14.5192 13.4111H5.98077C5.79206 13.4111 5.61108 13.3321 5.47764 13.1915C5.3442 13.0508 5.26923 12.86 5.26923 12.6611C5.26923 12.4622 5.3442 12.2715 5.47764 12.1308C5.61108 11.9902 5.79206 11.9111 5.98077 11.9111H14.5192C14.7079 11.9111 14.8889 11.9902 15.0224 12.1308C15.1558 12.2715 15.2308 12.4622 15.2308 12.6611C15.2308 12.86 15.1558 13.0508 15.0224 13.1915C14.8889 13.3321 14.7079 13.4111 14.5192 13.4111ZM14.5192 10.4111H5.98077C5.79206 10.4111 5.61108 10.3321 5.47764 10.1915C5.3442 10.0508 5.26923 9.86005 5.26923 9.66113C5.26923 9.46222 5.3442 9.27146 5.47764 9.1308C5.61108 8.99015 5.79206 8.91113 5.98077 8.91113H14.5192C14.7079 8.91113 14.8889 8.99015 15.0224 9.1308C15.1558 9.27146 15.2308 9.46222 15.2308 9.66113C15.2308 9.86005 15.1558 10.0508 15.0224 10.1915C14.8889 10.3321 14.7079 10.4111 14.5192 10.4111Z" fill="#FEFEFE"></path></svg>';

  const INVENTORY_ICON = '<svg class="_icon_1yizy_1" role="img" width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.475 5.16841L10.6 1.40669C10.4163 1.30519 10.2099 1.25195 10 1.25195C9.79013 1.25195 9.58369 1.30519 9.4 1.40669L2.525 5.16997C2.32866 5.2774 2.16477 5.43557 2.05043 5.62796C1.93609 5.82035 1.87551 6.03992 1.875 6.26372V13.7356C1.87551 13.9594 1.93609 14.179 2.05043 14.3714C2.16477 14.5638 2.32866 14.7219 2.525 14.8293L9.4 18.5926C9.58369 18.6941 9.79013 18.7474 10 18.7474C10.2099 18.7474 10.4163 18.6941 10.6 18.5926L17.475 14.8293C17.6713 14.7219 17.8352 14.5638 17.9496 14.3714C18.0639 14.179 18.1245 13.9594 18.125 13.7356V6.2645C18.1249 6.0403 18.0645 5.82025 17.9502 5.62741C17.8358 5.43456 17.6717 5.27603 17.475 5.16841ZM10 2.50044L16.2766 5.93794L13.9508 7.21138L7.67344 3.77388L10 2.50044ZM10 9.37544L3.72344 5.93794L6.37187 4.48794L12.6484 7.92544L10 9.37544ZM16.875 13.7333L10.625 17.1543V10.4551L13.125 9.08716V11.8754C13.125 12.0412 13.1908 12.2002 13.3081 12.3174C13.4253 12.4346 13.5842 12.5004 13.75 12.5004C13.9158 12.5004 14.0747 12.4346 14.1919 12.3174C14.3092 12.2002 14.375 12.0412 14.375 11.8754V8.40279L16.875 7.03169V13.7333Z" fill="#FEFEFE"></path></svg>';

  const ORDERS_ICON = '<svg class="_icon_1yizy_1" role="img" width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M8.08008 2.5C8.26019 2.5 8.43471 2.53639 8.60352 2.60938C8.77251 2.68231 8.91911 2.7808 9.04297 2.9043L15.4375 9.30566C15.5741 9.44108 15.6737 9.5935 15.7363 9.7627C15.7989 9.93192 15.831 10.1014 15.8311 10.2715C15.8311 10.4416 15.7989 10.609 15.7363 10.7734C15.6736 10.9381 15.5742 11.0894 15.4375 11.2256L10.3965 16.2627C10.2609 16.3973 10.1079 16.498 9.93848 16.5654C9.76901 16.6327 9.60011 16.667 9.43164 16.667C9.26301 16.667 9.09441 16.6328 8.92578 16.5654C8.75725 16.498 8.60545 16.3973 8.4707 16.2627L2.05762 9.86133C1.93039 9.73905 1.83316 9.59544 1.76562 9.43066C1.69826 9.26599 1.6641 9.09293 1.66406 8.91113V3.85449C1.66417 3.4822 1.79623 3.16374 2.05957 2.89844C2.32324 2.63312 2.64367 2.5 3.02051 2.5H8.08008ZM11.4053 2.5C11.5856 2.50002 11.7607 2.53632 11.9297 2.60938C12.0988 2.68231 12.2452 2.78083 12.3691 2.9043L18.7705 9.30566C18.9072 9.44107 19.0076 9.59352 19.0703 9.7627C19.1329 9.93183 19.164 10.1015 19.1641 10.2715C19.1641 10.4416 19.1329 10.6091 19.0703 10.7734C19.0076 10.9381 18.9073 11.0894 18.7705 11.2256L13.7236 16.2627C13.588 16.3973 13.4352 16.498 13.2656 16.5654C13.0959 16.6328 12.9265 16.667 12.7578 16.667C12.5892 16.6669 12.4206 16.6327 12.252 16.5654C12.0832 16.498 11.9308 16.3973 11.7959 16.2627L11.6396 16.1064L16.5293 11.2256C16.6661 11.0894 16.7664 10.9381 16.8291 10.7734C16.8917 10.6091 16.9229 10.4416 16.9229 10.2715C16.9228 10.1015 16.8917 9.93185 16.8291 9.7627C16.7664 9.59349 16.6661 9.44109 16.5293 9.30566L10.1279 2.9043C10.004 2.78083 9.8576 2.6823 9.68848 2.60938C9.5194 2.5363 9.34447 2.5 9.16406 2.5H11.4053ZM4.66992 4.56445C4.4091 4.56457 4.18746 4.65598 4.00488 4.83789C3.82209 5.01992 3.7305 5.24093 3.73047 5.50098C3.73047 5.76085 3.82185 5.98144 4.00391 6.16309C4.18611 6.34464 4.40766 6.43555 4.66797 6.43555C4.928 6.43546 5.14931 6.34516 5.33105 6.16406C5.51259 5.98293 5.60351 5.76276 5.60352 5.50391C5.60352 5.24307 5.51239 5.02142 5.33105 4.83887C5.14973 4.65621 4.92909 4.56445 4.66992 4.56445Z" fill="#FEFEFE"></path><path d="M8.08008 2.5C8.26019 2.5 8.43471 2.53639 8.60352 2.60938C8.77251 2.68231 8.91911 2.7808 9.04297 2.9043L15.4375 9.30566C15.5741 9.44108 15.6737 9.5935 15.7363 9.7627C15.7989 9.93192 15.831 10.1014 15.8311 10.2715C15.8311 10.4416 15.7989 10.609 15.7363 10.7734C15.6736 10.9381 15.5742 11.0894 15.4375 11.2256L10.3965 16.2627C10.2609 16.3973 10.1079 16.498 9.93848 16.5654C9.76901 16.6327 9.60011 16.667 9.43164 16.667C9.26301 16.667 9.09441 16.6328 8.92578 16.5654C8.75725 16.498 8.60545 16.3973 8.4707 16.2627L2.05762 9.86133C1.93039 9.73905 1.83316 9.59544 1.76562 9.43066C1.69826 9.26599 1.6641 9.09293 1.66406 8.91113V3.85449C1.66417 3.4822 1.79623 3.16374 2.05957 2.89844C2.32324 2.63312 2.64367 2.5 3.02051 2.5H8.08008ZM11.4053 2.5C11.5856 2.50002 11.7607 2.53632 11.9297 2.60938C12.0988 2.68231 12.2452 2.78083 12.3691 2.9043L18.7705 9.30566C18.9072 9.44107 19.0076 9.59352 19.0703 9.7627C19.1329 9.93183 19.164 10.1015 19.1641 10.2715C19.1641 10.4416 19.1329 10.6091 19.0703 10.7734C19.0076 10.9381 18.9073 11.0894 18.7705 11.2256L13.7236 16.2627C13.588 16.3973 13.4352 16.498 13.2656 16.5654C13.0959 16.6328 12.9265 16.667 12.7578 16.667C12.5892 16.6669 12.4206 16.6327 12.252 16.5654C12.0832 16.498 11.9308 16.3973 11.7959 16.2627L11.6396 16.1064L16.5293 11.2256C16.6661 11.0894 16.7664 10.9381 16.8291 10.7734C16.8917 10.6091 16.9229 10.4416 16.9229 10.2715C16.9228 10.1015 16.8917 9.93185 16.8291 9.7627C16.7664 9.59349 16.6661 9.44109 16.5293 9.30566L10.1279 2.9043C10.004 2.78083 9.8576 2.6823 9.68848 2.60938C9.5194 2.5363 9.34447 2.5 9.16406 2.5H11.4053ZM4.66992 4.56445C4.4091 4.56457 4.18746 4.65598 4.00488 4.83789C3.82209 5.01992 3.7305 5.24093 3.73047 5.50098C3.73047 5.76085 3.82185 5.98144 4.00391 6.16309C4.18611 6.34464 4.40766 6.43555 4.66797 6.43555C4.928 6.43546 5.14931 6.34516 5.33105 6.16406C5.51259 5.98293 5.60351 5.76276 5.60352 5.50391C5.60352 5.24307 5.51239 5.02142 5.33105 4.83887C5.14973 4.65621 4.92909 4.56445 4.66992 4.56445Z" stroke="#0F0F0F"></path></svg>';

  let rules = /*css*/`
  .de-shortcut-item {
    cursor: pointer;
    font-size: 14px;
    color: white;
    list-style-type: none;
  }

  .de-shortcut-item.hidden {
    display: none;
  }

  .de-shortcut-item a,
  .de-shortcut-item a:visited svg {
    color: white;
    fill: white;
  }

  .de-shortcut-item:hover {
    background: #31312f;
  }

  .de-shortcut-item svg {
    fill: #ffffff;
  }

  .de-shortcut-item span,
  .de-shortcut-item span i {
    pointer-events: none;
  }

  .de-shortcut-item-tooltip {
    background: #000;
    border-radius: 4px;
    color: #fff;
    display: block;
    font-size: 16px;
    height: 18px;
    left: 50%;
    line-height: 18px;
    margin: auto;
    opacity: 0;
    padding: 0.5rem 1rem;
    pointer-events: none;
    position: absolute;
    text-align: center;
    top: 65px;
    transform: translateX(-50%) scale(.9);
    transition: opacity .2s,transform 1s;
    white-space: nowrap;
    width: auto;
  }

  .de-shortcut-item-tooltip.visible {
    transition: opacity .35s, transform .3s;
    transform: translateX(-50%) scale(1);
    opacity: 1;
  }

  .de-shortcut-item-tooltip::before {
    border-color: transparent transparent #000;
    border-style: solid;
    border-width: 0 5px 5px;
    content: "";
    height: 0;
    left: 50%;
    margin-left: -5px;
    position: absolute;
    top: -5px;
    width: 0;
  }
  .animate-in {
    animation: rotateIn .1s ease-in;
  }

  @keyframes rotateIn {
    from { transform: rotateX(90deg); }
    to { transform: rotateX(0deg); }
  }

  form#search-mini {
    width: 400px;
  }

  form#search-mini[class*="_focus_"] {
    width: 458px;
  }
  `;

  /////////////////////////////////////////
  // Functions ///////////////////////////
  ///////////////////////////////////////

  /**
   * Returns anchor / svg icon markup used in the shortcuts
   * @param {String} svg - SVG markup
   * @param {String} url - URL path
   * @param {String} shortcutName - Name to display in the tooltip
   * @returns String template
   */
   function navbarIcon(svg, url, shortcutName) {
    return `
      <a href=${url} class="de-shortcut-item animate-in">
        <div style="position: relative; padding-top: 1.1rem; padding-right: 1.4rem; padding-left: 1.2rem;">
            ${svg}
          <div class="de-shortcut-item-tooltip">${shortcutName}</div>
        </div>
      </a>
    `;
  }

  /**
   * Adds mouse over/out, focus event listeners
   */
  function addListeners() {
    [..._header.querySelectorAll('.de-shortcut-item')].forEach(item => {
      // Show the tooltips
      ['mouseover', 'focusin'].forEach(event => {
        item.addEventListener(event, () => {
          item.querySelector('.de-shortcut-item-tooltip').classList.add('visible');
        }, false);
      });

      // Hide the tooltips
      ['mouseout', 'focusout'].forEach(event => {
        item.addEventListener(event, () => {
          item.querySelector('.de-shortcut-item-tooltip').classList.remove('visible');
        }, false);
      });
    });

    // Hide shortcuts when mobile bars icon is visible
    const bars = _header.querySelector('[class*="_bars_"]');
    const resize = new ResizeObserver(entries => {
      for ( let entry of entries ) {
        if ( entry.contentRect.width === 0 ) {
          _header.querySelectorAll('.de-shortcut-item').forEach(item => item.classList.remove('hidden'));
        } else {
          _header.querySelectorAll('.de-shortcut-item').forEach(item => item.classList.add('hidden'));
        }
      }
    });
    resize.observe(bars);
  }

  /////////////////////////////////////////
  // DOM Setup ///////////////////////////
  ///////////////////////////////////////

  let { navbarShortcuts } = rl.getPreference('featureData'),
      _header = host ? host.shadowRoot.querySelector('div[class^="_amped_"] header') : document,
      selector = host ? '[id^=__header_root_]' : 'nav[class^="_user_"] a',
      icon_map = {
        'collection_icon': COLLECTION_ICON,
        'collection_url': COLLECTION_URL,
        'collection_tooltip': 'Collection',

        'inventory_icon': INVENTORY_ICON,
        'inventory_url': INVENTORY_URL,
        'inventory_tooltip': 'Inventory',

        'itemsIWant_icon': ITEMSIWANT_ICON,
        'itemsIWant_url': ITEMSIWANT_URL,
        'itemsIWant_tooltip': 'Items I Want',

        'orders_icon': ORDERS_ICON,
        'orders_url': ORDERS_URL,
        'orders_tooltip': 'Orders',

        'purchases_icon': PURCHASES_ICON,
        'purchases_url': PURCHASES_URL,
        'purchases_tooltip': 'Purchases',

        'subsAndDrafts_icon': SUBMISSIONS_DRAFTS_ICON,
        'subsAndDrafts_url': SUBMISSIONS_DRAFTS_URL,
        'subsAndDrafts_tooltip': 'Submissions & Drafts',
      };

  // Attach CSS rules
  if ( host && host.shadowRoot ) {

    let css = document.createElement('style'),
        fragment = document.createDocumentFragment();

    css.id = 'shortcuts-item';
    css.rel = 'stylesheet';
    css.type = 'text/css';
    css.textContent = rules;

    fragment.appendChild(css);
    host.shadowRoot.appendChild(fragment.cloneNode(true));
  }

  rl.waitForElement(selector).then(() => {
    setTimeout(() => {
      let count = 0;
      for ( let [key, value] of Object.entries(navbarShortcuts) ) {
        if (value) {
          _header.querySelector('nav[class^="_user_"]')
            .insertAdjacentHTML(
              'afterbegin',
              navbarIcon(
                icon_map[`${key}_icon`],
                icon_map[`${key}_url`],
                icon_map[`${key}_tooltip`]
              )
            );
            count++;
        }
      }
      // Shorten the search bar when there are a lot of shortcuts rendered
      if ( count > 4 ) {
        _header.querySelector('form[class*="_search_"]').id = 'search-mini';
      }
      // mouse over/out focus listeners
      addListeners();
    }, 250);
  });
 });
